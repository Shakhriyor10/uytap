{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Главная — Мой Airbnb</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    body { background-color: #fdf6f0; }
    .listing-card {
      border-radius: 15px;
      overflow: hidden;
      transition: 0.3s;
      background: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      height: 100%;
      cursor: pointer;
    }
    .listing-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    .listing-img { height: 200px; object-fit: cover; width: 100%; border-bottom: 1px solid #eee; }
    .listing-body { padding: 15px; }
    .listing-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 6px; }
    .listing-city { color: #555; font-size: 0.95rem; margin-bottom: 6px; }
    .listing-price { font-weight: 700; font-size: 1.05rem; margin-bottom: 6px; color: #e63946; }
    .btn-custom {
      background: linear-gradient(90deg, #ff7e5f, #feb47b);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      transition: 0.3s;
    }
    .btn-custom:hover {
      background: linear-gradient(90deg, #feb47b, #ff7e5f);
      color: #fff;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .map-wrapper {
      position: sticky;
      top: 20px;
      height: 80vh;
      min-height: 480px;
      max-height: 80vh;
    }
    #map { height: 100%; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .price-marker {
      background: #fff;
      padding: 6px 10px;
      border-radius: 20px;
      border: 1px solid #ddd;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      font-weight: 700;
      color: #111;
    }
    .filter-label { font-size: 0.9rem; color: #555; }
  </style>
</head>
<body>

<div class="container py-4">
  <h1 class="mb-4 text-center">Список квартир</h1>

  <form id="filters-form" class="row gy-3 align-items-end">
    <div class="col-md-3">
      <label class="filter-label mb-1">Город</label>
      <select name="city" class="form-select">
        <option value="">Все города</option>
        {% for city in cities %}
          <option value="{{ city.id }}" {% if city.id|stringformat:"s" == selected_city %}selected{% endif %}>{{ city.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="filter-label mb-1">Тип жилья</label>
      <select name="property_type" class="form-select">
        <option value="">Все типы</option>
        {% for key,label in property_types %}
          <option value="{{ key }}" {% if key == selected_type %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="filter-label mb-1">Даты</label>
      <input type="text" id="date-range" class="form-control" placeholder="Выберите даты" autocomplete="off">
      <input type="hidden" name="check_in" value="{{ selected_check_in }}">
      <input type="hidden" name="check_out" value="{{ selected_check_out }}">
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-custom w-100">Фильтровать</button>
    </div>
  </form>

  <div class="row mt-4 g-4">
    <div id="listings-column" class="col-12">
      <div id="listings-container" class="row g-4">
        {% for listing in listings %}
        <div class="col-sm-6 col-lg-3 listing-col">
          <div class="card listing-card" data-listing-id="{{ listing.id }}">
            {% with image=listing.get_main_image %}
              {% if image %}
                <img src="{{ image.image.url }}" alt="{{ listing.title }}" class="listing-img">
              {% else %}
                <img src="{% static 'placeholder.png' %}" alt="Нет фото" class="listing-img">
              {% endif %}
            {% endwith %}
            <div class="listing-body">
              <div class="listing-title">{{ listing.title }}</div>
              <div class="listing-city">{{ listing.city }}</div>
              <div class="listing-price">{{ listing.price_per_day }} $/день</div>
              <div class="text-muted small">{{ listing.get_property_type_display }}</div>
            </div>
          </div>
        </div>
        {% empty %}
        <p>Объявлений пока нет.</p>
        {% endfor %}
      </div>
    </div>
    <div id="map-column" class="col-12 col-lg-6 d-none">
      <div class="map-wrapper d-none" id="map-section">
        <div id="map" class="visually-hidden"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="listingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="listingModalLabel">Объявление</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="listingCarousel" class="carousel slide mb-3">
          <div class="carousel-indicators"></div>
          <div class="carousel-inner"></div>
          <button class="carousel-control-prev" type="button" data-bs-target="#listingCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Предыдущий</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#listingCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Следующий</span>
          </button>
        </div>
        <p class="text-muted mb-2" id="listingAddress"></p>
        <p id="listingDescription" class="mb-3"></p>
        <div class="row g-3">
          <div class="col-sm-6 col-lg-4">
            <div class="p-3 bg-light rounded">
              <div class="fw-semibold text-secondary">Стоимость</div>
              <div class="fs-5" id="listingPrice"></div>
            </div>
          </div>
          <div class="col-sm-6 col-lg-4">
            <div class="p-3 bg-light rounded">
              <div class="fw-semibold text-secondary">Тип жилья</div>
              <div class="fs-6" id="listingType"></div>
            </div>
          </div>
          <div class="col-sm-6 col-lg-4">
            <div class="p-3 bg-light rounded">
              <div class="fw-semibold text-secondary">Гостей</div>
              <div class="fs-6" id="listingGuests"></div>
            </div>
          </div>
          <div class="col-sm-6 col-lg-4">
            <div class="p-3 bg-light rounded">
              <div class="fw-semibold text-secondary">Комнат</div>
              <div class="fs-6" id="listingRooms"></div>
            </div>
          </div>
          <div class="col-sm-6 col-lg-4">
            <div class="p-3 bg-light rounded">
              <div class="fw-semibold text-secondary">Кроватей</div>
              <div class="fs-6" id="listingBeds"></div>
            </div>
          </div>
          <div class="col-sm-6 col-lg-4">
            <div class="p-3 bg-light rounded">
              <div class="fw-semibold text-secondary">Санузлов</div>
              <div class="fs-6" id="listingBaths"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  const form = document.getElementById('filters-form');
  const listingsContainer = document.getElementById('listings-container');
  const listingsColumn = document.getElementById('listings-column');
  const dateRangeInput = document.getElementById('date-range');
  const checkInInput = form.querySelector('input[name="check_in"]');
  const checkOutInput = form.querySelector('input[name="check_out"]');
  const mapSection = document.getElementById('map-section');
  const mapColumn = document.getElementById('map-column');

  let map = null;
  let markersLayer = null;
  let mapInitialized = false;
  let compactGrid = false;
  const placeholderImage = "{% static 'placeholder.png' %}";
  const listingModalElement = document.getElementById('listingModal');
  const listingModal = new bootstrap.Modal(listingModalElement);
  const modalTitle = document.getElementById('listingModalLabel');
  const modalAddress = document.getElementById('listingAddress');
  const modalDescription = document.getElementById('listingDescription');
  const modalPrice = document.getElementById('listingPrice');
  const modalType = document.getElementById('listingType');
  const modalGuests = document.getElementById('listingGuests');
  const modalRooms = document.getElementById('listingRooms');
  const modalBeds = document.getElementById('listingBeds');
  const modalBaths = document.getElementById('listingBaths');
  const carouselIndicators = document.querySelector('#listingCarousel .carousel-indicators');
  const carouselInner = document.querySelector('#listingCarousel .carousel-inner');
  const carouselElement = document.getElementById('listingCarousel');

  function refreshMapSize() {
    if (!mapInitialized) return;
    requestAnimationFrame(() => map.invalidateSize());
  }

  function buildParams(includeBounds = true) {
    const formData = new FormData(form);
    const params = new URLSearchParams();
    for (const [key, value] of formData.entries()) {
      if (value) params.append(key, value);
    }

    if (includeBounds && mapInitialized) {
      const bounds = map.getBounds();
      params.set('south', bounds.getSouth());
      params.set('west', bounds.getWest());
      params.set('north', bounds.getNorth());
      params.set('east', bounds.getEast());
    }
    return params;
  }

  function renderListings(listings) {
    listingsContainer.innerHTML = '';
    if (!listings.length) {
      listingsContainer.innerHTML = '<p class="text-muted">Нет объявлений в этой области.</p>';
      return;
    }

    listings.forEach((listing) => {
      const col = document.createElement('div');
      col.className = 'col-sm-6 col-lg-3 listing-col';
      col.innerHTML = `
        <div class="card listing-card" data-listing-id="${listing.id}">
          <img src="${listing.image}" alt="${listing.title}" class="listing-img">
          <div class="listing-body">
            <div class="listing-title">${listing.title}</div>
            <div class="listing-city">${listing.city}</div>
            <div class="listing-price">${listing.price} $/день</div>
            <div class="text-muted small">${listing.property_type}</div>
          </div>
        </div>`;
      listingsContainer.appendChild(col);
    });

    applyListingGrid();
    attachListingCardHandlers();
  }

  function setGridMode(compact) {
    compactGrid = compact;
    applyListingGrid();
  }

  function applyListingGrid() {
    const listingCols = listingsContainer.querySelectorAll('.listing-col');
    listingCols.forEach((col) => {
      col.classList.remove('col-lg-3', 'col-lg-6');
      col.classList.add(compactGrid ? 'col-lg-6' : 'col-lg-3');
    });
  }

  function showMapLayout() {
    mapColumn.classList.remove('d-none');
    mapSection.classList.remove('d-none');
    listingsColumn.classList.add('col-lg-6');
    updateGridForScroll();
  }

  function ensureMapInitialized(center = null) {
    showMapLayout();
    if (mapInitialized) return;

    const initialCenter = center || [41.3111, 69.2797];
    mapSection.classList.remove('d-none');
    const mapElement = document.getElementById('map');
    mapElement.classList.remove('visually-hidden');

    map = L.map(mapElement).setView(initialCenter, 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);
    markersLayer = L.layerGroup().addTo(map);
    map.on('moveend', () => {
      loadListings({ includeMapBounds: true });
      refreshMapSize();
    });
    mapInitialized = true;
    refreshMapSize();
    updateGridForScroll();
  }

  function updateGridForScroll() {
    if (!mapInitialized) {
      setGridMode(false);
      return;
    }

    const scrollY = window.scrollY || window.pageYOffset;
    const mapBottom = mapSection.offsetTop + mapSection.offsetHeight;
    const compact = scrollY < mapBottom;
    setGridMode(compact);
  }

  function renderMarkers(listings) {
    if (!mapInitialized) return;
    markersLayer.clearLayers();
    listings.forEach((listing) => {
      if (listing.lat === null || listing.lng === null) return;
      const icon = L.divIcon({
        className: 'price-marker',
        html: `${listing.price} $`
      });
      const marker = L.marker([listing.lat, listing.lng], { icon });
      marker.bindPopup(`<strong>${listing.title}</strong><br>${listing.city}<br>${listing.price} $/день`);
      markersLayer.addLayer(marker);
    });
  }

  function listingsCenter(listings) {
    const withCoords = listings.find((listing) => listing.lat !== null && listing.lng !== null);
    return withCoords ? [withCoords.lat, withCoords.lng] : [41.3111, 69.2797];
  }

  async function loadListings({ includeMapBounds = false, showMap = false, extraParams = {} } = {}) {
    const params = buildParams(includeMapBounds && mapInitialized);
    Object.entries(extraParams).forEach(([key, value]) => {
      if (value !== undefined && value !== null && value !== '') {
        params.set(key, value);
      }
    });

    const url = `/api/listings/?${params.toString()}`;
    const response = await fetch(url);
    const data = await response.json();
    renderListings(data.results);

    if (showMap) {
      ensureMapInitialized(listingsCenter(data.results));
    }

    if (mapInitialized) {
      renderMarkers(data.results);
      refreshMapSize();
    }
  }

  function loadNearbyListings() {
    if (!navigator.geolocation) return;

    navigator.geolocation.getCurrentPosition(
      (position) => {
        const { latitude, longitude } = position.coords;
        const delta = 0.3; // ~30km box around the user
        loadListings({
          includeMapBounds: false,
          extraParams: {
            south: latitude - delta,
            west: longitude - delta,
            north: latitude + delta,
            east: longitude + delta,
          },
        });
      },
      () => {},
      { enableHighAccuracy: true }
    );
  }

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    loadListings({ showMap: true, includeMapBounds: mapInitialized });
  });

  function buildCarousel(images) {
    carouselIndicators.innerHTML = '';
    carouselInner.innerHTML = '';

    const hasMultiple = images.length > 1;
    carouselElement.querySelectorAll('.carousel-control-prev, .carousel-control-next').forEach((control) => {
      control.style.display = hasMultiple ? '' : 'none';
    });

    images.forEach((image, index) => {
      const indicator = document.createElement('button');
      indicator.type = 'button';
      indicator.dataset.bsTarget = '#listingCarousel';
      indicator.dataset.bsSlideTo = index;
      indicator.ariaLabel = `Слайд ${index + 1}`;
      if (index === 0) indicator.classList.add('active');
      indicator.ariaCurrent = index === 0 ? 'true' : undefined;
      carouselIndicators.appendChild(indicator);

      const item = document.createElement('div');
      item.className = 'carousel-item' + (index === 0 ? ' active' : '');
      item.innerHTML = `<img src="${image.url}" class="d-block w-100" style="max-height:400px; object-fit: cover;" alt="Фото объявления">`;
      if (image.caption) {
        const caption = document.createElement('div');
        caption.className = 'carousel-caption d-none d-md-block';
        caption.textContent = image.caption;
        item.appendChild(caption);
      }
      carouselInner.appendChild(item);
    });
  }

  function populateListingModal(data) {
    modalTitle.textContent = data.title;
    modalAddress.textContent = `${data.city}${data.address ? ', ' + data.address : ''}`;
    modalDescription.textContent = data.description || 'Описание скоро появится.';
    modalPrice.textContent = `${data.price} $/день`;
    modalType.textContent = data.property_type;
    modalGuests.textContent = `${data.guests} гостей`;
    modalRooms.textContent = `${data.rooms} комнат`;
    modalBeds.textContent = `${data.beds} кроватей`;
    modalBaths.textContent = `${data.baths} санузлов`;

    const images = data.images && data.images.length ? data.images : [{ url: data.cover_image || placeholderImage }];
    buildCarousel(images);
    listingModal.show();
  }

  async function openListingModal(listingId) {
    try {
      const response = await fetch(`/api/listings/${listingId}/`);
      if (!response.ok) return;
      const data = await response.json();
      populateListingModal(data);
    } catch (error) {
      console.error('Не удалось загрузить объявление', error);
    }
  }

  function attachListingCardHandlers() {
    document.querySelectorAll('.listing-card[data-listing-id]').forEach((card) => {
      card.addEventListener('click', () => openListingModal(card.dataset.listingId));
    });
  }

  window.addEventListener('resize', refreshMapSize);
  window.addEventListener('scroll', updateGridForScroll);

  const defaultDates = [];
  {% if selected_check_in %}defaultDates.push('{{ selected_check_in }}');{% endif %}
  {% if selected_check_out %}defaultDates.push('{{ selected_check_out }}');{% endif %}

  const fp = flatpickr(dateRangeInput, {
    mode: 'range',
    dateFormat: 'Y-m-d',
    defaultDate: defaultDates.length ? defaultDates : null,
    onChange: (selectedDates, dateStr, instance) => {
      const [start, end] = selectedDates;
      checkInInput.value = start ? instance.formatDate(start, 'Y-m-d') : '';
      checkOutInput.value = end ? instance.formatDate(end, 'Y-m-d') : '';
    },
  });

  // Set initial hidden values if default dates existed
  if (defaultDates.length) {
    checkInInput.value = defaultDates[0] || '';
    checkOutInput.value = defaultDates[1] || '';
  }

  loadNearbyListings();
  attachListingCardHandlers();
</script>
</body>
</html>